<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title><%= title %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/user.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
      .popup-img { max-width:200px; border-radius:6px; display:block; margin-top:5px; }
      .hidden { display:none; }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="main-header">ğŸ“ Civic Issue Reporting</header>

    <!-- Dashboard split -->
    <div class="dashboard">
      
      <!-- Left: Form Section -->
      <div class="form-section">
        <h2>Report an Issue</h2>
        <form action="/report" method="POST" enctype="multipart/form-data" id="issueForm" class="issue-form">

          <label for="username">Name</label>
          <input type="text" name="username" id="username" required placeholder="Your Name"/>

          <label for="category">Category</label>
          <select name="category" id="category" required>
            <option value="">--Select--</option>
            <option value="Potholes">Potholes</option>
            <option value="Street Light">Street Light</option>
            <option value="Water Overflow">Water Overflow</option>
            <option value="Dustbin Overflow">Dustbin Overflow</option>
          </select>

          <label for="description">Description</label>
          <textarea name="description" id="description" required placeholder="Describe issue"></textarea>

          <!-- Camera Section -->
          <div class="camera-section">
            <button type="button" id="cameraBtn">ğŸ“· Open Camera</button>
            <div id="cameraOptions" class="hidden">
              <button type="button" id="frontCam">Front Camera</button>
              <button type="button" id="backCam">Back Camera</button>
            </div>
            <video id="video" autoplay playsinline class="hidden"></video>
            <button type="button" id="captureBtn" class="hidden">ğŸ“¸ Capture</button>
            <canvas id="canvas" class="hidden"></canvas>
            <img id="photoPreview" class="hidden" alt="Captured Image"/>
            <input type="file" name="image" id="imageInput" class="hidden" accept="image/*"/>
          </div>

          <!-- Hidden Lat/Lng -->
          <input type="hidden" name="latitude" id="issueLat" required />
          <input type="hidden" name="longitude" id="issueLng" required />

          <!-- Actions: Get Location + Submit Issue -->
          <div class="form-actions">
            <button type="button" class="location-btn" id="getLoc">ğŸ“ Get My Location</button>
            <button type="submit" class="submit-btn">ğŸš€ Submit Issue</button>
          </div>
        </form>
      </div>

      <!-- Right: Map Section -->
      <div class="map-section">
        <div id="map"></div>
      </div>
    </div>
    <footer>
      this is footer
    </footer>

    <!-- Leaflet + Cluster -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script type="module">
      import { initializeMap } from "/js/map.js";
      import { initGeolocation } from "/js/geolocation.js";
      import { initCamera } from "/js/camera.js";

      const issues = JSON.parse('<%- JSON.stringify(issues || []) %>');
      const map = initializeMap(issues);
      initGeolocation(map);
      initCamera();
    </script>
  </body>
</html>
