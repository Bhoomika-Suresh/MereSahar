<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MereSahar - User Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"
    />
    <style>
      #map { height: 600px; width: 100%; margin-top: 20px; }
      .popup-img { max-width: 200px; border-radius: 6px; display: block; margin-top: 5px; }
      .hidden { display: none; }
    </style>
  </head>
  <body>
    <header class="main-header">
      <h1>üìç Civic Issue Reporting</h1>
    </header>

    <div class="dashboard">
      <!-- Left: Form -->
      <div class="form-section">
        <h2>Report an Issue</h2>
        <form
          action="/report"
          method="POST"
          enctype="multipart/form-data"
          id="issueForm"
          class="issue-form"
        >
          <label for="username">Your Name</label>
          <input type="text" name="username" id="username" required placeholder="Enter your name" />

          <label for="category">Category</label>
          <select name="category" id="category" required>
            <option value="">-- Select Category --</option>
            <option value="Potholes">Potholes</option>
            <option value="Street Light">Street Light</option>
            <option value="Water Overflow">Water Overflow</option>
            <option value="Dustbin Overflow">Dustbin Overflow</option>
          </select>

          <label for="description">Description</label>
          <textarea name="description" id="description" placeholder="Describe the issue..." required></textarea>

          <div class="camera-section">
            <label>Capture Image (Optional)</label>
            <button type="button" id="cameraBtn">üì∑ Open Camera</button>
            <div id="cameraOptions" class="hidden">
              <button type="button" id="frontCam">Front Camera</button>
              <button type="button" id="backCam">Back Camera</button>
            </div>

            <video id="video" autoplay playsinline class="hidden"></video>
            <button type="button" id="captureBtn" class="hidden">üì∏ Capture</button>
            <canvas id="canvas" class="hidden"></canvas>
            <img id="photoPreview" class="hidden" alt="Captured Image" />
            <input type="file" name="image" id="imageInput" class="hidden" accept="image/*" />
          </div>

          <input type="hidden" name="latitude" id="issueLat" required />
          <input type="hidden" name="longitude" id="issueLng" required />

          <div class="form-actions">
            <button type="button" id="getLoc">üìç Get My Location</button>
            <button type="submit">üöÄ Submit Issue</button>
          </div>
        </form>
      </div>

      <!-- Right: Map -->
      <div class="map-section">
        <div id="map"></div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    
    <!-- Modular JS -->
    <script type="module">
      import { initializeMap } from "/js/map.js";
      import { initGeolocation } from "/js/geolocation.js";
      import { initCamera } from "/js/camera.js";

      // Issues passed from server
      const issues = JSON.parse('<%- JSON.stringify(issues || []) %>');

      // Initialize map with markers
      const map = initializeMap(issues);

      // Initialize geolocation for "Get My Location"
      initGeolocation(map);

      // Initialize camera functionality
      initCamera();
    </script>
  </body>
</html>
